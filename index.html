<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ä°zgi ğŸ’˜ Sevgililer GÃ¼nÃ¼</title>
  <style>
    :root{
      --bg1:#12051a; --bg2:#2b0b2a;
      --card:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.72);
      --pink:#ff4d8d; --pink2:#ff79b0; --gold:#ffd6a6;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 800px at 20% 10%, #3a0f3e 0%, transparent 55%),
                  radial-gradient(900px 600px at 90% 30%, #2a0e3f 0%, transparent 60%),
                  linear-gradient(160deg, var(--bg1), var(--bg2));
      min-height:100vh; overflow-x:hidden;
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .topbar{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      position:sticky;top:0;z-index:10;padding:12px 0;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;gap:10px;align-items:center;}
    .logo{
      width:38px;height:38px;border-radius:14px;
      background: linear-gradient(135deg, var(--pink), #b14cff);
      box-shadow: 0 10px 30px rgba(255,77,141,.25);
      display:grid;place-items:center;font-size:20px;
    }
    .brand h1{font-size:15px;margin:0;letter-spacing:.2px}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .pillrow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      padding:8px 10px;border-radius:999px;
      background: var(--card); border:1px solid var(--stroke);
      color:var(--muted); font-size:12px;
    }
    .btn{
      border:0; cursor:pointer; user-select:none;
      padding:10px 12px;border-radius:14px;font-weight:700;
      background: linear-gradient(135deg, var(--pink), var(--pink2));
      color:white;
      box-shadow: 0 12px 30px rgba(255,77,141,.22);
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{
      background: rgba(255,255,255,.10);
      border:1px solid var(--stroke);
      box-shadow:none;
    }

    .grid{display:grid;gap:14px;grid-template-columns: 1.2fr .8fr;align-items:start}
    @media (max-width:900px){.grid{grid-template-columns:1fr}.pillrow{justify-content:flex-start}}
    .card{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius:22px;
      padding:16px;
      box-shadow: 0 18px 40px rgba(0,0,0,.25);
    }
    .hero{
      padding:18px;
      background:
        radial-gradient(700px 260px at 20% 0%, rgba(255,77,141,.22), transparent 55%),
        radial-gradient(520px 240px at 90% 30%, rgba(177,76,255,.18), transparent 55%),
        var(--card);
      border:1px solid var(--stroke);
      border-radius:22px;
    }
    .hero h2{margin:0;font-size:22px;letter-spacing:.2px}
    .hero p{margin:8px 0 0;color:var(--muted);line-height:1.55}
    .steps{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .step{
      flex:1; min-width:190px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:12px;
    }
    .step b{display:block;font-size:12px;color:var(--gold);letter-spacing:.5px}
    .step span{display:block;margin-top:6px;color:var(--muted);font-size:13px;line-height:1.4}

    .stageTitle{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .stageTitle h3{margin:0;font-size:16px}
    .stageTitle .hint{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .input{
      width:100%;
      padding:12px 14px;border-radius:16px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.22);
      color:var(--text); outline:none;
      font-size:14px;
    }
    .input::placeholder{color:rgba(255,255,255,.45)}
    .msg{margin-top:10px;color:var(--muted);line-height:1.55;font-size:13px;min-height:22px}

    /* Memory game */
    .board{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px}
    @media (max-width:640px){ .board{grid-template-columns:repeat(2,1fr)} }
    .tile{
      position:relative;height:86px;border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      overflow:hidden; cursor:pointer;
      display:grid;place-items:center;
      font-size:30px; transition: transform .08s;
    }
    .tile:active{transform:scale(.99)}
    .tile .cover{
      position:absolute;inset:0;
      background: linear-gradient(135deg, rgba(255,77,141,.35), rgba(177,76,255,.25));
      display:grid;place-items:center;
      font-size:16px;font-weight:800;letter-spacing:.8px;
      color:rgba(255,255,255,.92);
      transition: opacity .18s;
    }
    .tile.revealed .cover{opacity:0;pointer-events:none}
    .tile.matched{outline:2px solid rgba(255,214,166,.35)}

    /* Heart catch (FIXED + EASIER) */
    .arena{
      position:relative;
      height:340px;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.14);
      background: radial-gradient(500px 200px at 50% 0%, rgba(255,77,141,.18), transparent 60%),
                  rgba(0,0,0,.18);
      overflow:hidden;
      margin-top:12px;
      touch-action: manipulation;
    }
    .heart{
      position:absolute;
      font-size:44px; /* bigger */
      filter: drop-shadow(0 10px 16px rgba(255,77,141,.25));
      user-select:none;
      cursor:pointer;
      padding:6px; /* easier to tap */
      line-height:1;
    }
    .stats{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .stat{padding:8px 10px;border-radius:16px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);font-size:12px;color:var(--muted)}
    .stat b{color:var(--text)}

    /* Modal */
    .modal{
      position:fixed;inset:0;display:none;place-items:center;
      background: rgba(0,0,0,.6);
      z-index:30;
      padding:18px;
    }
    .modal .box{max-width:740px;width:100%}
    .finalHead{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .type{
      margin-top:10px;
      font-size:16px;
      line-height:1.75;
      color:rgba(255,255,255,.92);
      white-space:pre-wrap;
      min-height:120px;
    }
    .tiny{font-size:12px;color:var(--muted);margin-top:10px}
    canvas#rain{position:fixed;inset:0;pointer-events:none;display:none;z-index:25}
  </style>
</head>
<body>
  <canvas id="rain"></canvas>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">ğŸ’˜</div>
        <div>
          <h1>Ä°zgi iÃ§in Sevgililer GÃ¼nÃ¼</h1>
          <div class="sub">Bansko â€¢ Binicilik â€¢ Sinema â€¢ Kayak â€¢ Yemek â€¢ Roma LUISS ğŸ‡®ğŸ‡¹ğŸ“</div>
        </div>
      </div>
      <div class="pillrow">
        <span class="pill">AÅŸama: <b id="stagePill">0/3</b></span>
        <button class="btn secondary" id="musicBtn">ğŸ”ˆ MÃ¼zik</button>
        <button class="btn" id="startBtn">BaÅŸla âœ¨</button>
      </div>
    </div>

    <div class="grid">
      <div class="hero">
        <h2>Minik bir oyunâ€¦ ama hisler gerÃ§ek ğŸ’—</h2>
        <p>Ä°zgi, bu sayfayÄ± aÃ§tÄ±ysanâ€¦ bugÃ¼n kÃ¼Ã§Ã¼k bir maceraya giriyorsun. 3 aÅŸamayÄ± geÃ§ince finalde sÃ¼rpriz var.</p>
        <div class="steps">
          <div class="step"><b>1) Åifre</b><span>Gizli bir anahtar ğŸ’Œ</span></div>
          <div class="step"><b>2) AnÄ±lar</b><span>4 Ã§ifti eÅŸleÅŸtir</span></div>
          <div class="step"><b>3) Kalp Yakala</b><span>Kolay mod ğŸ’˜</span></div>
        </div>
      </div>

      <div class="card">
        <div class="stageTitle">
          <h3>Durum</h3>
          <div class="hint" id="statusHint">BaÅŸlaâ€™ya basÄ±nca oyun aÃ§Ä±lÄ±r.</div>
        </div>
        <div class="msg" id="statusMsg"></div>
        <div class="row" style="margin-top:12px">
          <button class="btn secondary" id="resetBtn">SÄ±fÄ±rla</button>
        </div>
        <div class="tiny">Not: Telefonda mÃ¼zik otomatik baÅŸlamaz; â€œBaÅŸlaâ€ ile baÅŸlatÄ±yoruz.</div>
      </div>
    </div>

    <!-- Stage 1 (no hints/answers shown) -->
    <div class="card" id="stage1" style="margin-top:14px; display:none">
      <div class="stageTitle">
        <h3>1) Åifreyi Gir ğŸ”</h3>
        <div class="hint">Sadece senin bileceÄŸin bir ÅŸey ğŸ’Œ</div>
      </div>
      <div class="msg">Åifreyi yaz ve devam et ğŸ’˜</div>
      <div class="row" style="margin-top:12px">
        <input class="input" id="passInput" placeholder="Åifre..." />
        <button class="btn" id="passBtn">Onayla</button>
      </div>
      <div class="msg" id="passMsg"></div>
    </div>

    <!-- Stage 2 -->
    <div class="card" id="stage2" style="margin-top:14px; display:none">
      <div class="stageTitle">
        <h3>2) AnÄ±larÄ± EÅŸleÅŸtir ğŸ§©</h3>
        <div class="hint"><span id="matchCount">0</span>/4 bulundu</div>
      </div>
      <div class="msg">Minik dÃ¼nyanÄ±z: Bansko â›·ï¸ â€¢ Binicilik ğŸ‡ â€¢ Sinema ğŸ¿ â€¢ Roma LUISS ğŸ‡®ğŸ‡¹ğŸ“</div>
      <div class="board" id="board"></div>
      <div class="msg" id="boardMsg"></div>
    </div>

    <!-- Stage 3 (easier) -->
    <div class="card" id="stage3" style="margin-top:14px; display:none">
      <div class="stageTitle">
        <h3>3) Kalp Yakala ğŸ’–</h3>
        <div class="hint">20 saniyede <b>8</b> kalp</div>
      </div>
      <div class="arena" id="arena"></div>
      <div class="stats">
        <div class="stat">SÃ¼re: <b id="timeLeft">20</b>s</div>
        <div class="stat">Toplanan: <b id="caught">0</b>/8</div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="catchStart">BaÅŸlat ğŸš€</button>
      </div>
      <div class="msg" id="catchMsg"></div>
    </div>
  </div>

  <!-- Final Modal -->
  <div class="modal" id="modal">
    <div class="card box">
      <div class="finalHead">
        <h3 style="margin:0">Final ğŸ’˜</h3>
        <div class="row">
          <button class="btn secondary" id="againBtn">Tekrar Oyna</button>
          <button class="btn" id="closeBtn">Kapat</button>
        </div>
      </div>
      <div class="type" id="type"></div>
      <div class="tiny">ÅarkÄ±: repoya <b>song.mp3</b> yÃ¼klersen (root), BaÅŸlaâ€™ya basÄ±nca Ã§alar.</div>
    </div>
  </div>

  <audio id="bgm" loop>
    <source src="song.mp3" type="audio/mpeg" />
  </audio>

<script>
(() => {
  const GIRL_NAME = "Ä°zgi";

  // Gizli ÅŸifreler (sayfada yazmÄ±yor)
  const MEET_PASSWORDS = [
    "02022025","02/02/2025","2/2/2025","2 ÅŸubat 2025","2 subat 2025","02.02.2025","2.2.2025",
    "bansko", "bansko kayak merkezi"
  ];

  const FINAL_TEXT =
`Ä°zgi,

Banskoâ€™da baÅŸlayan o anâ€¦ benim iÃ§in â€œtamamâ€ anÄ±ydÄ±.
Senin yanÄ±ndayken dÃ¼nya daha yumuÅŸak: daha gÃ¼venli, daha gÃ¼zel.

Sen bal gibi dÃ¼nya tatlÄ±sÄ±sÄ±nâ€¦
ve hep destekÃ§i olman benim iÃ§in ayrÄ± bir gÃ¼Ã§. ğŸ’—

Ben de sana hep ince dÃ¼ÅŸÃ¼neyim:
Sinema gibi birlikte izleyelim,
kayak gibi birlikte kayalÄ±m,
yemek gibi birlikte paylaÅŸalÄ±m,
ve binicilik gibi hep gururla, hep gÃ¼Ã§lÃ¼ devam edelim. ğŸ‡

Ve bir gÃ¼nâ€¦
Romaâ€™da LUISS hayalini birlikte kutlayalÄ±m.
Sen baÅŸarÄ±nca ben de mutlu oluyorum. Hep yanÄ±ndayÄ±m. ğŸ‡®ğŸ‡¹ğŸ’˜

Sevgililer gÃ¼nÃ¼n kutlu olsun.
Ä°yi ki varsÄ±n. ğŸ’˜`;

  const $ = (id) => document.getElementById(id);

  const startBtn = $("startBtn");
  const resetBtn = $("resetBtn");
  const musicBtn = $("musicBtn");

  const stagePill = $("stagePill");
  const statusHint = $("statusHint");
  const statusMsg = $("statusMsg");

  const s1 = $("stage1");
  const s2 = $("stage2");
  const s3 = $("stage3");

  const passInput = $("passInput");
  const passBtn = $("passBtn");
  const passMsg = $("passMsg");

  const board = $("board");
  const boardMsg = $("boardMsg");
  const matchCount = $("matchCount");

  const arena = $("arena");
  const catchStart = $("catchStart");
  const caughtEl = $("caught");
  const timeLeftEl = $("timeLeft");
  const catchMsg = $("catchMsg");

  const modal = $("modal");
  const closeBtn = $("closeBtn");
  const againBtn = $("againBtn");
  const typeEl = $("type");

  const bgm = $("bgm");

  const rainCanvas = $("rain");
  const ctx = rainCanvas.getContext("2d");

  // ===== State =====
  let stage = 0;
  let musicOn = false;

  // memory
  let openTiles = [];
  let matched = 0;
  const TOTAL_PAIRS = 4;

  // catch (EASY)
  let catchRunning = false;
  let caught = 0;
  let timeLeft = 20;
  const CATCH_GOAL = 8;
  let spawnTimer = null;
  let countdownTimer = null;

  // ===== Helpers =====
  const normalize = (s) =>
    (s || "")
      .toLowerCase()
      .replaceAll("Ä±","i")
      .replaceAll("ÅŸ","s")
      .replaceAll("ÄŸ","g")
      .replaceAll("Ã¼","u")
      .replaceAll("Ã¶","o")
      .replaceAll("Ã§","c")
      .replace(/\s+/g," ")
      .trim();

  const shuffle = (arr) => {
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  };

  const setStage = (n) => {
    stage = n;
    stagePill.textContent = `${stage}/3`;
    s1.style.display = stage >= 1 ? "block" : "none";
    s2.style.display = stage >= 2 ? "block" : "none";
    s3.style.display = stage >= 3 ? "block" : "none";

    if(stage === 0){
      statusHint.textContent = "BaÅŸlaâ€™ya basÄ±nca oyun aÃ§Ä±lÄ±r.";
      statusMsg.textContent = "";
    }
    if(stage === 1){
      statusHint.textContent = "Åifreyi girince devam eder ğŸ’Œ";
      statusMsg.textContent = `HoÅŸ geldin ${GIRL_NAME} ğŸ’—`;
    }
    if(stage === 2){
      statusHint.textContent = `${TOTAL_PAIRS} eÅŸleÅŸme yapÄ±nca 3. aÅŸama aÃ§Ä±lÄ±r.`;
      statusMsg.textContent = "KartlarÄ± eÅŸleÅŸtir ğŸ’—";
    }
    if(stage === 3){
      statusHint.textContent = "Kalpleri topla, final aÃ§Ä±lÄ±r ğŸ’˜";
      statusMsg.textContent = "Kolay mod aÃ§Ä±k ğŸ˜„";
    }
  };

  const safePlayMusic = async () => {
    try{
      await bgm.play();
      musicOn = true;
      musicBtn.textContent = "ğŸ”Š MÃ¼zik";
    }catch(e){
      musicOn = false;
      musicBtn.textContent = "ğŸ”ˆ MÃ¼zik";
    }
  };

  const toggleMusic = async () => {
    if(musicOn){
      bgm.pause();
      musicOn = false;
      musicBtn.textContent = "ğŸ”ˆ MÃ¼zik";
    }else{
      await safePlayMusic();
    }
  };

  // ===== Stage 1 =====
  const checkPassword = () => {
    const n = normalize(passInput.value);
    const ok = MEET_PASSWORDS.some(p => normalize(p) === n);
    if(ok){
      passMsg.textContent = "DoÄŸru ğŸ’˜";
      setTimeout(() => { initMemory(); setStage(2); }, 450);
    }else{
      passMsg.textContent = "OlmadÄ± ğŸ™ˆ Tekrar dene.";
    }
  };

  // ===== Stage 2 =====
  function initMemory(){
    board.innerHTML = "";
    boardMsg.textContent = "";
    openTiles = [];
    matched = 0;
    matchCount.textContent = "0";

    const pairs = [
      {k:"bansko", icon:"â›·ï¸"},
      {k:"horse",  icon:"ğŸ‡"},
      {k:"cinema", icon:"ğŸ¿"},
      {k:"luiss",  icon:"ğŸ‡®ğŸ‡¹ğŸ“"},
    ];

    const tiles = shuffle([...pairs, ...pairs]);
    tiles.forEach(t => {
      const el = document.createElement("div");
      el.className = "tile";
      el.dataset.key = t.k;
      el.innerHTML = `<div aria-hidden="true">${t.icon}</div><div class="cover">AÃ‡</div>`;
      el.addEventListener("click", () => onTile(el));
      board.appendChild(el);
    });
  }

  function onTile(el){
    if(el.classList.contains("matched")) return;
    if(el.classList.contains("revealed")) return;
    if(openTiles.length >= 2) return;

    el.classList.add("revealed");
    openTiles.push(el);

    if(openTiles.length === 2){
      const [a,b] = openTiles;
      const same = a.dataset.key === b.dataset.key;
      if(same){
        a.classList.add("matched");
        b.classList.add("matched");
        openTiles = [];
        matched++;
        matchCount.textContent = String(matched);

        boardMsg.textContent =
          matched === 1 ? "TatlÄ± ğŸ’—" :
          matched === 2 ? "Devam ğŸ˜„" :
          matched === 3 ? "Az kaldÄ± ğŸ¥°" :
          "Tamam ğŸ’˜";

        if(matched >= TOTAL_PAIRS){
          setTimeout(() => setStage(3), 500);
        }
      }else{
        setTimeout(() => {
          a.classList.remove("revealed");
          b.classList.remove("revealed");
          openTiles = [];
        }, 550);
      }
    }
  }

  // ===== Stage 3 (FIXED) =====
  function resetCatch(){
    catchRunning = false;
    caught = 0;
    timeLeft = 20;
    caughtEl.textContent = "0";
    timeLeftEl.textContent = "20";
    catchMsg.textContent = "";
    arena.innerHTML = "";
    if(spawnTimer) clearInterval(spawnTimer);
    if(countdownTimer) clearInterval(countdownTimer);
  }

  function spawnHeart(){
    const el = document.createElement("div");
    el.className = "heart";
    el.textContent = (Math.random() < 0.25) ? "ğŸ’˜" : "ğŸ’—";

    // easier tap: keep inside area
    const maxX = Math.max(10, arena.clientWidth - 70);
    const x = 10 + Math.random() * maxX;
    el.style.left = x + "px";
    el.style.top  = "-60px";

    // slower fall
    const speed = 1.2 + Math.random() * 1.2;
    let y = -60;
    let alive = true;

    const tick = () => {
      if(!alive) return;
      if(!catchRunning){ el.remove(); return; }
      y += speed;
      el.style.top = y + "px";
      if(y > arena.clientHeight + 80){
        el.remove();
        alive = false;
        return;
      }
      requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);

    // pointer events for better mobile tapping
    const hit = (e) => {
      e.preventDefault();
      e.stopPropagation();
      if(!catchRunning) return;
      caught++;
      caughtEl.textContent = String(caught);
      el.remove();
      alive = false;
      if(caught >= CATCH_GOAL) finishGame();
    };
    el.addEventListener("pointerdown", hit, {passive:false});
    el.addEventListener("click", hit);

    arena.appendChild(el);
  }

  function startCatch(){
    if(catchRunning) return;
    resetCatch();
    catchRunning = true;
    catchMsg.textContent = "Kalplere dokun ğŸ’—";

    // fewer hearts, slower spawn
    spawnTimer = setInterval(spawnHeart, 600);

    countdownTimer = setInterval(() => {
      timeLeft--;
      timeLeftEl.textContent = String(timeLeft);
      if(timeLeft <= 0){
        endCatchFail();
      }
    }, 1000);
  }

  function endCatchFail(){
    catchRunning = false;
    if(spawnTimer) clearInterval(spawnTimer);
    if(countdownTimer) clearInterval(countdownTimer);
    catchMsg.textContent = "OlmadÄ±ysa sorun deÄŸil ğŸ˜„ Tekrar dene!";
  }

  // ===== Final =====
  function typeWriter(text){
    typeEl.textContent = "";
    let i = 0;
    const t = setInterval(() => {
      typeEl.textContent += text[i] || "";
      i++;
      if(i >= text.length) clearInterval(t);
    }, 18);
  }

  function openFinal(){
    modal.style.display = "grid";
    typeWriter(FINAL_TEXT);
    startHeartRain(340);
  }

  function closeFinal(){
    modal.style.display = "none";
    stopHeartRain();
  }

  function finishGame(){
    catchRunning = false;
    if(spawnTimer) clearInterval(spawnTimer);
    if(countdownTimer) clearInterval(countdownTimer);
    catchMsg.textContent = "Tamam ğŸ’˜";
    setTimeout(openFinal, 450);
  }

  // ===== Heart rain =====
  let rainOn = false;
  let particles = [];
  let rainRAF = null;

  function resizeCanvas(){
    rainCanvas.width = window.innerWidth * devicePixelRatio;
    rainCanvas.height = window.innerHeight * devicePixelRatio;
    rainCanvas.style.width = window.innerWidth + "px";
    rainCanvas.style.height = window.innerHeight + "px";
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }

  function startHeartRain(count){
    resizeCanvas();
    rainCanvas.style.display = "block";
    rainOn = true;
    particles = [];
    const emojis = ["ğŸ’—","ğŸ’–","ğŸ’˜","ğŸ’•","ğŸ’"];
    for(let i=0;i<count;i++){
      particles.push({
        x: Math.random()*window.innerWidth,
        y: -Math.random()*window.innerHeight,
        vy: 2 + Math.random()*5.5,
        vx: -1 + Math.random()*2,
        s: 16 + Math.random()*18,
        r: Math.random()*Math.PI*2,
        w: emojis[Math.floor(Math.random()*emojis.length)]
      });
    }
    const loop = () => {
      if(!rainOn) return;
      ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
      for(const p of particles){
        p.x += p.vx;
        p.y += p.vy;
        p.r += 0.02;
        if(p.y > window.innerHeight + 40){
          p.y = -40;
          p.x = Math.random()*window.innerWidth;
        }
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.r);
        ctx.font = `${p.s}px system-ui`;
        ctx.fillText(p.w, 0, 0);
        ctx.restore();
      }
      rainRAF = requestAnimationFrame(loop);
    };
    loop();
  }

  function stopHeartRain(){
    rainOn = false;
    rainCanvas.style.display = "none";
    if(rainRAF) cancelAnimationFrame(rainRAF);
  }

  // ===== Controls =====
  function resetAll(){
    closeFinal();
    resetCatch();
    passInput.value = "";
    passMsg.textContent = "";
    boardMsg.textContent = "";
    setStage(0);
    statusMsg.textContent = "";
  }

  startBtn.addEventListener("click", async () => {
    setStage(1);
    await safePlayMusic(); // allowed by user gesture
    passInput.focus();
  });

  resetBtn.addEventListener("click", resetAll);
  musicBtn.addEventListener("click", toggleMusic);
  passBtn.addEventListener("click", checkPassword);
  passInput.addEventListener("keydown", (e) => { if(e.key === "Enter") checkPassword(); });

  catchStart.addEventListener("click", startCatch);

  closeBtn.addEventListener("click", closeFinal);
  againBtn.addEventListener("click", () => { closeFinal(); resetAll(); });

  resetAll();
})();
</script>
</body>
</html>
