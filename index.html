<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Bansko Slalom â€” Animasyonlu ğŸ’˜</title>
  <style>
    :root{
      --bg1:#12051a; --bg2:#2b0b2a;
      --card:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.72);
      --pink:#ff4d8d; --pink2:#ff79b0;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 800px at 20% 10%, #3a0f3e 0%, transparent 55%),
                  radial-gradient(900px 600px at 90% 30%, #2a0e3f 0%, transparent 60%),
                  linear-gradient(160deg, var(--bg1), var(--bg2));
      min-height:100vh; overflow:hidden;
    }
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      position:fixed;left:0;right:0;top:0;z-index:10;
      padding:12px 14px;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:38px;height:38px;border-radius:14px;
      background: linear-gradient(135deg, #ff4d8d, #b14cff);
      box-shadow: 0 10px 30px rgba(255,77,141,.25);
      display:grid;place-items:center;font-size:20px;
    }
    .title{margin:0;font-size:14px}
    .sub{margin-top:2px;font-size:12px;color:var(--muted)}
    .hud{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      padding:8px 10px;border-radius:999px;
      background: var(--card); border:1px solid var(--stroke);
      color:var(--muted); font-size:12px;
      display:flex;gap:6px;align-items:center;
    }
    .pill b{color:var(--text)}
    .btn{
      border:0; cursor:pointer; user-select:none;
      padding:10px 12px;border-radius:14px;font-weight:900;
      background: linear-gradient(135deg, var(--pink), var(--pink2));
      color:white;
      box-shadow: 0 12px 30px rgba(255,77,141,.22);
    }
    .btn.secondary{
      background: rgba(255,255,255,.10);
      border:1px solid var(--stroke);
      box-shadow:none;
    }
    .game{
      position:fixed; inset:0;
      padding-top:72px;
      display:grid; place-items:center;
    }
    canvas{
      width:min(940px, 96vw);
      height:min(640px, 78vh);
      border-radius:22px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 40px rgba(0,0,0,.25);
      touch-action:none;
    }
    .controls{
      position:fixed;left:0;right:0;bottom:10px;z-index:12;
      display:flex;justify-content:center;gap:12px;pointer-events:none;
    }
    .pad{
      pointer-events:auto;
      width:min(180px, 44vw);
      padding:14px;border-radius:18px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
      user-select:none;
    }
    .pad:active{transform:scale(.99)}
    .tip{
      position:fixed;left:14px;right:14px;bottom:74px;z-index:11;
      color:var(--muted);font-size:12px;text-align:center;
    }

    /* Modal */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.6);z-index:20;padding:16px}
    .card{max-width:760px;width:100%;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);border-radius:22px;padding:16px;box-shadow:0 18px 40px rgba(0,0,0,.3)}
    .card h2{margin:0;font-size:18px}
    .card p{margin:10px 0 0;color:var(--muted);line-height:1.6;white-space:pre-wrap}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:14px}
    .tiny{font-size:12px;color:var(--muted);margin-top:10px}

    canvas#rain{position:fixed;inset:0;display:none;pointer-events:none;z-index:19}
  </style>
</head>
<body>
  <canvas id="rain"></canvas>

  <div class="topbar">
    <div class="brand">
      <div class="logo">â›·ï¸</div>
      <div>
        <p class="title">Bansko Slalom â€” Animasyonlu</p>
        <div class="sub">Kar â€¢ HÄ±z â€¢ Combo â€¢ Finalde sÃ¼rpriz ğŸ’˜</div>
      </div>
    </div>
    <div class="hud">
      <div class="pill">Skor: <b id="score">0</b></div>
      <div class="pill">Combo: <b id="combo">x1</b></div>
      <div class="pill">Level: <b id="level">1</b></div>
      <div class="pill">Can: <b id="lives">3</b></div>
      <button class="btn secondary" id="musicBtn">ğŸ”ˆ MÃ¼zik</button>
      <button class="btn" id="startBtn">BaÅŸlat</button>
    </div>
  </div>

  <div class="game">
    <canvas id="c" width="940" height="640"></canvas>
  </div>

  <div class="tip" id="tip">Telefon: â—€ â–¶ â€¢ PC: â† â†’ â€¢ KapÄ±lardan geÃ§ (kÄ±rmÄ±zÄ±/mavi), Ã§amlara Ã§arpma.</div>

  <div class="controls">
    <div class="pad" id="leftPad">â—€ SOL</div>
    <div class="pad" id="rightPad">SAÄ â–¶</div>
  </div>

  <div class="modal" id="modal">
    <div class="card">
      <h2 id="modalTitle">Bansko Slalom</h2>
      <p id="modalText"></p>
      <div class="row">
        <button class="btn" id="playAgain">Tekrar Oyna</button>
        <button class="btn secondary" id="closeModal">Kapat</button>
      </div>
      <div class="tiny">ÅarkÄ±: repo kÃ¶kÃ¼ne <b>song.mp3</b> koyduysan â€œMÃ¼zikâ€ ile aÃ§Ä±lÄ±r.</div>
    </div>
  </div>

  <audio id="bgm" loop>
    <source src="song.mp3" type="audio/mpeg" />
  </audio>

<script>
(() => {
  const GIRL_NAME = "Ä°zgi";
  const FINAL_SCORE_TO_WIN = 140;

  const FINAL_TEXT =
`Ä°zgi ğŸ’˜

Banskoâ€™da birlikte kaydÄ±ÄŸÄ±mÄ±z o anâ€¦
benim iÃ§in hÃ¢lÃ¢ en gÃ¼zel â€œbaÅŸlangÄ±Ã§â€lardan.

Romaâ€™da LUISS master hayalini
birlikte kutlayacaÄŸÄ±z. ğŸ‡®ğŸ‡¹ğŸ“

Sevgililer gÃ¼nÃ¼n kutlu olsun.
Ä°yi ki varsÄ±n. ğŸ’—`;

  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");

  const scoreEl = document.getElementById("score");
  const comboEl = document.getElementById("combo");
  const levelEl = document.getElementById("level");
  const livesEl = document.getElementById("lives");
  const startBtn = document.getElementById("startBtn");
  const musicBtn = document.getElementById("musicBtn");
  const tip = document.getElementById("tip");

  const leftPad = document.getElementById("leftPad");
  const rightPad = document.getElementById("rightPad");

  const modal = document.getElementById("modal");
  const modalTitle = document.getElementById("modalTitle");
  const modalText = document.getElementById("modalText");
  const playAgain = document.getElementById("playAgain");
  const closeModal = document.getElementById("closeModal");

  const bgm = document.getElementById("bgm");

  // Heart rain
  const rainCanvas = document.getElementById("rain");
  const rctx = rainCanvas.getContext("2d");
  let rainOn=false, particles=[], rainRAF=null;
  function resizeRain(){
    rainCanvas.width = window.innerWidth * devicePixelRatio;
    rainCanvas.height = window.innerHeight * devicePixelRatio;
    rainCanvas.style.width = window.innerWidth + "px";
    rainCanvas.style.height = window.innerHeight + "px";
    rctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }
  function startHeartRain(count=340){
    resizeRain(); rainCanvas.style.display="block"; rainOn=true; particles=[];
    const emojis=["ğŸ’—","ğŸ’–","ğŸ’˜","ğŸ’•","ğŸ’"];
    for(let i=0;i<count;i++){
      particles.push({
        x:Math.random()*window.innerWidth,
        y:-Math.random()*window.innerHeight,
        vy:2+Math.random()*5.8,
        vx:-1+Math.random()*2,
        s:16+Math.random()*18,
        r:Math.random()*Math.PI*2,
        w:emojis[Math.floor(Math.random()*emojis.length)]
      });
    }
    const loop=()=>{
      if(!rainOn) return;
      rctx.clearRect(0,0,window.innerWidth,window.innerHeight);
      for(const p of particles){
        p.x+=p.vx; p.y+=p.vy; p.r+=0.02;
        if(p.y>window.innerHeight+40){p.y=-40; p.x=Math.random()*window.innerWidth}
        rctx.save(); rctx.translate(p.x,p.y); rctx.rotate(p.r);
        rctx.font=`${p.s}px system-ui`; rctx.fillText(p.w,0,0); rctx.restore();
      }
      rainRAF=requestAnimationFrame(loop);
    };
    loop();
  }
  function stopHeartRain(){
    rainOn=false; rainCanvas.style.display="none";
    if(rainRAF) cancelAnimationFrame(rainRAF);
  }

  // ===== Game state =====
  const W = canvas.width, H = canvas.height;

  const player = {
    x: W/2, y: H*0.80,
    vx: 0, tilt: 0,
    maxSpeed: 7.0,
  };

  // snow particles
  const snow = Array.from({length: 140}, () => ({
    x: Math.random()*W,
    y: Math.random()*H,
    s: 1 + Math.random()*2.2,
    v: 1.2 + Math.random()*2.4,
    drift: -0.8 + Math.random()*1.6
  }));

  let running=false;
  let score=0;
  let level=1;
  let lives=3;
  let combo=1;
  let comboTimer=0;

  let t=0;
  let laneCenter=W/2;
  let laneWidth=260;
  let speed=3.2;
  let spawnCd=0;

  let objects=[];
  let inputLeft=false, inputRight=false;

  // fx bursts
  let bursts=[]; // {x,y,a,life}

  function resetGame(){
    running=false;
    score=0; level=1; lives=3;
    combo=1; comboTimer=0;
    t=0; laneCenter=W/2; laneWidth=260; speed=3.2; spawnCd=0;
    objects=[]; bursts=[];
    player.x=W/2; player.vx=0; player.tilt=0;
    syncHUD();
    tip.textContent="BaÅŸlatâ€™a bas. KapÄ±lardan geÃ§, combo yap, Ã§amlara Ã§arpma.";
  }

  function syncHUD(){
    scoreEl.textContent = Math.floor(score);
    comboEl.textContent = "x" + combo;
    levelEl.textContent = level;
    livesEl.textContent = lives;
  }

  function showModal(title, text){
    modalTitle.textContent=title;
    modalText.textContent=text;
    modal.style.display="grid";
  }
  function hideModal(){ modal.style.display="none"; }

  function flashBurst(x,y){
    bursts.push({x,y,a:1,life:22});
  }

  function damage(){
    lives--;
    combo=1; comboTimer=0;
    syncHUD();
    if(lives<=0) endGame(false);
  }

  function endGame(won){
    running=false;
    if(won){
      startHeartRain(380);
      showModal("Final ğŸ’˜", FINAL_TEXT);
    }else{
      showModal("Oyun Bitti ğŸ˜„", `Skor: ${Math.floor(score)}\n\nTekrar dener misin? Bu sefer ${GIRL_NAME} iÃ§in kazan ğŸ’˜`);
    }
  }

  // ===== Spawning =====
  function spawnGateRow(){
    laneCenter += Math.sin(t/38)*16 + (Math.random()-0.5)*34;
    laneCenter = Math.max(160, Math.min(W-160, laneCenter));

    const gap = Math.max(120, laneWidth - level*12);
    const leftX = laneCenter - gap/2;
    const rightX = laneCenter + gap/2;

    const y = -50;
    const rowId = Math.random().toString(16).slice(2);

    objects.push({type:"gateL", x:leftX, y, r:16, rowId, scored:false});
    objects.push({type:"gateR", x:rightX, y, r:16, rowId, scored:false});

    if(Math.random() < 0.70){
      const side = Math.random()<0.5 ? -1 : 1;
      const ox = laneCenter + side*(gap/2 + 80 + Math.random()*90);
      objects.push({type:"tree", x:ox, y, r:18});
    }

    if(Math.random() < 0.28){
      objects.push({type:"heart", x: laneCenter + (Math.random()-0.5)*100, y, r:18});
    }
  }

  // ===== Drawing helpers =====
  function drawBackground(){
    // slope gradient
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,"rgba(255,255,255,.09)");
    g.addColorStop(1,"rgba(0,0,0,.18)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    // vignette
    ctx.fillStyle = "rgba(0,0,0,.10)";
    ctx.fillRect(0,0,W,H);
  }

  function drawSnow(){
    ctx.save();
    ctx.globalAlpha = 0.75;
    ctx.fillStyle = "rgba(255,255,255,.55)";
    for(const p of snow){
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.s, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.restore();
  }

  function updateSnow(){
    for(const p of snow){
      p.y += p.v + speed*0.22;
      p.x += p.drift + player.vx*0.05;
      if(p.y > H+10){ p.y = -10; p.x = Math.random()*W; }
      if(p.x < -10) p.x = W+10;
      if(p.x > W+10) p.x = -10;
    }
  }

  function drawSpeedLines(){
    ctx.save();
    ctx.globalAlpha = 0.22;
    ctx.strokeStyle = "rgba(255,255,255,.35)";
    ctx.lineWidth = 2;
    for(let i=0;i<14;i++){
      const x = (i*80 + (t*3)%80);
      ctx.beginPath();
      ctx.moveTo(x, 0);
      ctx.lineTo(x-30, H);
      ctx.stroke();
    }
    ctx.restore();
  }

  function drawLaneHint(){
    ctx.save();
    ctx.globalAlpha = 0.22;
    ctx.strokeStyle = "rgba(255,255,255,.25)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(laneCenter - laneWidth/2, 0);
    ctx.lineTo(laneCenter - laneWidth/2 + 40, H);
    ctx.moveTo(laneCenter + laneWidth/2, 0);
    ctx.lineTo(laneCenter + laneWidth/2 + 40, H);
    ctx.stroke();
    ctx.restore();
  }

  function drawObj(o){
    if(o.type==="gateL" || o.type==="gateR"){
      const isL = o.type==="gateL";
      ctx.save();
      ctx.translate(o.x, o.y);
      ctx.strokeStyle = isL ? "rgba(255,90,90,.95)" : "rgba(90,170,255,.95)";
      ctx.lineWidth = 6;
      ctx.beginPath();
      ctx.moveTo(0,-18);
      ctx.lineTo(0,26);
      ctx.stroke();

      // flag with tiny wave
      const w = 28 + Math.sin((t+o.x)/12)*2;
      ctx.fillStyle = isL ? "rgba(255,90,90,.70)" : "rgba(90,170,255,.70)";
      ctx.beginPath();
      ctx.moveTo(0,-10);
      ctx.lineTo(isL ? -w : w, -2);
      ctx.lineTo(0, 8);
      ctx.closePath();
      ctx.fill();
      ctx.restore();
      return;
    }
    if(o.type==="tree"){
      ctx.save();
      ctx.translate(o.x,o.y);
      ctx.fillStyle="rgba(60,200,140,.78)";
      ctx.beginPath();
      ctx.moveTo(0,-26);
      ctx.lineTo(-20,16);
      ctx.lineTo(20,16);
      ctx.closePath();
      ctx.fill();
      ctx.fillStyle="rgba(255,255,255,.35)";
      ctx.beginPath(); ctx.arc(0,20,6,0,Math.PI*2); ctx.fill();
      ctx.restore();
      return;
    }
    if(o.type==="heart"){
      ctx.save();
      ctx.translate(o.x,o.y);
      ctx.font="30px system-ui";
      ctx.fillText("ğŸ’˜",-15,10);
      ctx.restore();
    }
  }

  function drawPlayer(){
    // tilt based on velocity
    player.tilt += ((player.vx / player.maxSpeed) - player.tilt) * 0.12;

    ctx.save();
    ctx.translate(player.x, player.y);
    ctx.rotate(player.tilt * 0.35);

    // shadow
    ctx.globalAlpha = 0.25;
    ctx.fillStyle = "rgba(0,0,0,.6)";
    ctx.beginPath();
    ctx.ellipse(0, 22, 20, 7, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1;

    // body
    ctx.fillStyle = "rgba(255,255,255,.92)";
    roundRect(-18,-24,36,48,12);
    ctx.fill();

    // scarf
    ctx.fillStyle = "rgba(255,77,141,.85)";
    ctx.fillRect(-18,-6,36,6);

    // head
    ctx.fillStyle = "rgba(255,255,255,.85)";
    ctx.beginPath(); ctx.arc(0,-28,10,0,Math.PI*2); ctx.fill();

    // skis
    ctx.strokeStyle = "rgba(255,214,166,.85)";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(-14, 22); ctx.lineTo(-32, 42);
    ctx.moveTo(14, 22);  ctx.lineTo(32, 42);
    ctx.stroke();

    ctx.restore();
  }

  function drawBursts(){
    ctx.save();
    for(const b of bursts){
      ctx.globalAlpha = b.a;
      ctx.fillStyle = "rgba(255,77,141,.25)";
      ctx.beginPath();
      ctx.arc(b.x, b.y, 26 - (22-b.life)*0.5, 0, Math.PI*2);
      ctx.fill();

      ctx.fillStyle = "rgba(255,255,255,.6)";
      ctx.beginPath();
      ctx.arc(b.x, b.y, 10, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.restore();
  }

  function updateBursts(){
    bursts = bursts.filter(b => b.life > 0);
    for(const b of bursts){
      b.life--;
      b.a *= 0.92;
    }
  }

  function roundRect(x,y,w,h,r){
    r = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  }

  // ===== Update loop =====
  function update(){
    if(!running) return;

    level = 1 + Math.floor(score / 55);
    level = Math.min(level, 8);
    speed = 3.0 + level*0.6;
    laneWidth = 270 - level*12;
    player.maxSpeed = 7.0 + level*0.2;

    // combo decay
    if(comboTimer > 0) comboTimer--;
    if(comboTimer === 0) combo = 1;

    // input
    const accel = 0.62;
    if(inputLeft && !inputRight) player.vx -= accel;
    if(inputRight && !inputLeft) player.vx += accel;
    if(!inputLeft && !inputRight) player.vx *= 0.84;

    player.vx = Math.max(-player.maxSpeed, Math.min(player.maxSpeed, player.vx));
    player.x += player.vx;

    // boundaries
    const margin = 56;
    if(player.x < margin){ player.x = margin; player.vx = 0; }
    if(player.x > W-margin){ player.x = W-margin; player.vx = 0; }

    // spawn
    spawnCd -= 1;
    if(spawnCd <= 0){
      spawnGateRow();
      spawnCd = Math.max(14, 32 - level*2);
    }

    // move objects
    for(const o of objects) o.y += speed;

    // collisions & scoring by row
    const pr = 16;
    // group by rowId at scoring line
    const gateLs = objects.filter(o => o.type==="gateL" && !o.scored && o.y >= player.y);
    for(const gl of gateLs){
      const gr = objects.find(o => o.type==="gateR" && o.rowId===gl.rowId && !o.scored && Math.abs(o.y - gl.y) < 8);
      if(!gr) continue;
      gl.scored = true; gr.scored = true;

      const minX = Math.min(gl.x, gr.x);
      const maxX = Math.max(gl.x, gr.x);

      if(player.x > minX && player.x < maxX){
        // success
        combo = Math.min(6, combo + 1);
        comboTimer = 90; // keep combo alive
        const gain = 10 * combo;
        score += gain;
        flashBurst(laneCenter, player.y - 90);
      }else{
        // miss
        combo = 1; comboTimer = 0;
        score = Math.max(0, score - 4);
      }
    }

    // trees + hearts
    for(const o of objects){
      if(o.hit) continue;

      if(o.type==="tree"){
        if(Math.hypot(player.x-o.x, player.y-o.y) < (pr + o.r)){
          o.hit = true;
          damage();
        }
      }
      if(o.type==="heart"){
        if(Math.hypot(player.x-o.x, player.y-o.y) < (pr + o.r)){
          o.hit = true;
          score += 12;
          flashBurst(o.x, o.y);
        }
      }
    }

    objects = objects.filter(o => o.y < H + 90);

    // passive score
    score += 0.06 * level;
    syncHUD();

    updateSnow();
    updateBursts();

    if(score >= FINAL_SCORE_TO_WIN){
      endGame(true);
    }
  }

  function render(){
    ctx.clearRect(0,0,W,H);

    drawBackground();
    drawSpeedLines();
    drawLaneHint();
    drawSnow();

    for(const o of objects) drawObj(o);

    drawBursts();
    drawPlayer();

    if(!running){
      ctx.save();
      ctx.fillStyle = "rgba(0,0,0,.28)";
      ctx.fillRect(0,0,W,H);
      ctx.fillStyle = "rgba(255,255,255,.95)";
      ctx.textAlign = "center";
      ctx.font = "900 34px system-ui";
      ctx.fillText("Bansko Slalom", W/2, H/2 - 34);
      ctx.font = "700 16px system-ui";
      ctx.fillStyle = "rgba(255,255,255,.78)";
      ctx.fillText("BaÅŸlat â€¢ KapÄ±lardan geÃ§ â€¢ Combo yap â€¢ Ã‡amlara Ã§arpma", W/2, H/2 + 6);
      ctx.fillText("Telefon: â—€ â–¶  |  PC: â† â†’", W/2, H/2 + 30);
      ctx.restore();
    }
  }

  function loop(){
    t++;
    update();
    render();
    requestAnimationFrame(loop);
  }

  // ===== Input =====
  function setPad(el, on){
    el.style.background = on ? "rgba(255,255,255,.18)" : "rgba(255,255,255,.10)";
  }
  const down = (side) => (e) => { e.preventDefault(); e.stopPropagation();
    if(side==="L"){ inputLeft=true; setPad(leftPad,true); }
    if(side==="R"){ inputRight=true; setPad(rightPad,true); }
  };
  const up = (side) => (e) => { e.preventDefault(); e.stopPropagation();
    if(side==="L"){ inputLeft=false; setPad(leftPad,false); }
    if(side==="R"){ inputRight=false; setPad(rightPad,false); }
  };

  leftPad.addEventListener("pointerdown", down("L"), {passive:false});
  leftPad.addEventListener("pointerup", up("L"), {passive:false});
  leftPad.addEventListener("pointercancel", up("L"), {passive:false});
  leftPad.addEventListener("pointerleave", up("L"), {passive:false});

  rightPad.addEventListener("pointerdown", down("R"), {passive:false});
  rightPad.addEventListener("pointerup", up("R"), {passive:false});
  rightPad.addEventListener("pointercancel", up("R"), {passive:false});
  rightPad.addEventListener("pointerleave", up("R"), {passive:false});

  window.addEventListener("keydown", (e) => {
    if(e.key === "ArrowLeft") inputLeft = true;
    if(e.key === "ArrowRight") inputRight = true;
  });
  window.addEventListener("keyup", (e) => {
    if(e.key === "ArrowLeft") inputLeft = false;
    if(e.key === "ArrowRight") inputRight = false;
  });

  // ===== Buttons =====
  async function playMusic(){
    try{ await bgm.play(); musicBtn.textContent="ğŸ”Š MÃ¼zik"; return true; }
    catch{ return false; }
  }
  function stopMusic(){ bgm.pause(); musicBtn.textContent="ğŸ”ˆ MÃ¼zik"; }

  startBtn.addEventListener("click", async () => {
    stopHeartRain();
    hideModal();
    await playMusic(); // user gesture allows audio
    if(!running){
      running = true;
      tip.textContent = "KapÄ±lardan geÃ§! Combo yaparsan skor uÃ§ar ğŸ’˜";
    }
  });

  musicBtn.addEventListener("click", async () => {
    if(bgm.paused){
      const ok = await playMusic();
      if(!ok) tip.textContent = "MÃ¼zik baÅŸlamadÄ±ysa: sessiz mod olabilir. Oyun yine Ã§alÄ±ÅŸÄ±r.";
    }else stopMusic();
  });

  playAgain.addEventListener("click", () => {
    stopHeartRain();
    hideModal();
    resetGame();
    running = true;
    tip.textContent = "Hadi tekrar! Bu sefer comboâ€™yu bÃ¼yÃ¼t ğŸ’˜";
  });

  closeModal.addEventListener("click", () => {
    stopHeartRain();
    hideModal();
  });

  window.addEventListener("resize", () => { if(rainOn) resizeRain(); });

  // init
  resetGame();
  loop();

  function resetGame(){
    running=false;
    score=0; level=1; lives=3;
    combo=1; comboTimer=0;
    t=0; laneCenter=W/2; laneWidth=260; speed=3.2; spawnCd=0;
    objects=[]; bursts=[];
    player.x=W/2; player.vx=0; player.tilt=0;
    syncHUD();
    tip.textContent="BaÅŸlatâ€™a bas. KapÄ±lardan geÃ§, combo yap, Ã§amlara Ã§arpma.";
  }
})();
</script>
</body>
</html>
